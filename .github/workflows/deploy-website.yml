name: API Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Doxygen 1.15.0 and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          wget https://github.com/doxygen/doxygen/releases/download/Release_1_15_0/doxygen-1.15.0.linux.bin.tar.gz
          tar -xzf doxygen-1.15.0.linux.bin.tar.gz
          sudo mv doxygen-1.15.0/bin/doxygen /usr/local/bin/doxygen
          doxygen --version

      - name: Verify Graphviz
        run: |
          which dot
          dot -V

      - name: Generate API Docs
        run: |
          rm -rf docs/api
          doxygen docs/Doxyfile.in

      - name: List Generated Files
        run: |
          echo "=== HTML ==="
          ls -la docs/api/html/ | head -20
          echo ""
          echo "=== XML ==="
          ls -la docs/api/xml/ | head -20

      - name: Upload HTML Docs
        uses: actions/upload-artifact@v4
        with:
          name: api-docs-html
          path: docs/api/html/
          retention-days: 30

      - name: Upload XML Docs
        uses: actions/upload-artifact@v4
        with:
          name: api-docs-xml
          path: docs/api/xml/
          retention-days: 30

      - name: Prepare publish dir (XML + archive)
        run: |
          rm -rf publish
          mkdir -p publish/api/xml
          rsync -a docs/api/html/ publish/api/
          rsync -a docs/api/xml/  publish/api/xml/
          tar -C docs/api -czf publish/api/xml.tgz xml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          cache-dependency-path: website/package-lock.json

      - name: Copy XML to website directory
        run: |
          rm -rf website/doxygen
          mkdir -p website/doxygen
          cp -r docs/api/xml/* website/doxygen/

      - name: Install dependencies
        working-directory: ./website
        run: npm ci

      - name: Build helios API docs
        working-directory: ./website
        run: npx doxygen2docusaurus --id helios

      - name: Build website
        working-directory: ./website
        run: npm run build

      - name: Merge API docs and website
        run: |
          # Merge the Doxygen HTML docs with the website build
          cp -r publish/api website/build/api
          # Ensure the xml.tgz is also available
          cp publish/api/xml.tgz website/build/api/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./website/build
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com