name: Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'include/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-windows:
    name: Windows Tests
    runs-on: windows-latest

    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j

    - name: Run Tests
      working-directory: build
      run: ctest -C ${{ matrix.build_type }} --output-on-failure --verbose

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-windows-${{ matrix.build_type }}
        path: build/Testing/Temporary/LastTest.log

  test-linux:
    name: Linux Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler:
          - { cc: gcc-13, cxx: g++-13 }
          - { cc: clang-17, cxx: clang++-17 }

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          xorg-dev \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev

    - name: Install compiler
      run: |
        sudo apt-get install -y ${{ matrix.compiler.cc }} ${{ matrix.compiler.cxx }}

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      env:
        CC: ${{ matrix.compiler.cc }}
        CXX: ${{ matrix.compiler.cxx }}
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j

    - name: Run Tests
      working-directory: build
      run: ctest --output-on-failure --verbose

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-linux-${{ matrix.compiler.cc }}-${{ matrix.build_type }}
        path: build/Testing/Temporary/LastTest.log

  test-macos:
    name: macOS Tests
    runs-on: macos-latest

    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j

    - name: Run Tests
      working-directory: build
      run: ctest --output-on-failure --verbose

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-macos-${{ matrix.build_type }}
        path: build/Testing/Temporary/LastTest.log

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-windows, test-linux, test-macos]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "All test jobs completed"
        if [ "${{ needs.test-windows.result }}" != "success" ] || \
           [ "${{ needs.test-linux.result }}" != "success" ] || \
           [ "${{ needs.test-macos.result }}" != "success" ]; then
          echo "❌ Some tests failed"
          exit 1
        else
          echo "✅ All tests passed"
        fi

