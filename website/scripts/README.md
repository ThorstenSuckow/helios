# Website Build Scripts

This directory contains build-time scripts for the helios Docusaurus website.

## Scripts

### `sync-changelog.mjs`

Synchronizes markdown documentation from the repository root into the website's `docs/` directory.

**Purpose:**
- Avoids duplicating documentation across repository and website
- Ensures single source of truth for documentation
- Automatically adds Docusaurus frontmatter (metadata)
- Escapes MDX-incompatible characters

**What it syncs:**

| Source File | Destination | Description |
|-------------|-------------|-------------|
| `CHANGELOG.md` | `docs/changelog.md` | Project changelog |
| `docs/styleguide.md` | `docs/contributing/styleguide.md` | Code style guide |
| `docs/doxygen-style.md` | `docs/contributing/doxygen-style.md` | Documentation style |
| `docs/CONTRIBUTING.md` | `docs/contributing/guide.md` | Contributing guide |
| `docs/CHANGELOG_GUIDE.md` | `docs/contributing/changelog-guide.md` | Changelog maintenance |
| `docs/testing.md` | `docs/testing.md` | Testing guide (CTest) |
| `docs/PREREQUISITES.md` | `docs/prerequisites.md` | Build prerequisites |
| **Core Concepts (Source of Truth)** | | |
| `docs/core-concepts/conventions.md` | `docs/core-concepts/conventions.md` | LHS, matrix storage, units |
| `docs/core-concepts/scene-graph.md` | `docs/core-concepts/scene-graph.md` | Scene hierarchy, transforms |
| `docs/core-concepts/component-system.md` | `docs/core-concepts/component-system.md` | Components, Systems, GameWorld |
| `docs/core-concepts/gameloop-architecture.md` | `docs/core-concepts/gameloop-architecture.md` | Commands, Events, EventBus |
| **Examples** | | |
| `examples/README.md` | `docs/examples/overview.md` | Examples overview |
| `examples/simple_cube_rendering/README.md` | `docs/examples/simple-cube.md` | Cube rendering tutorial |
| `examples/game_controller_input/README.md` | `docs/examples/gamepad-input.md` | Gamepad input tutorial |
| `examples/spaceship_control/README.md` | `docs/examples/spaceship-control.md` | Spaceship control demo |
| `examples/spaceship_shooting/README.md` | `docs/examples/spaceship-shooting.md` | Twin-stick shooting demo |
| `examples/enemy_spawn/README.md` | `docs/examples/enemy-spawn.md` | Enemy spawn demo |
| `examples/collision_detection/README.md` | `docs/examples/collision-detection.md` | Collision detection demo |

**Usage:**

```bash
# Manual sync (from website/ directory)
node scripts/sync-changelog.mjs

# Automatic sync (runs during npm run build)
npm run build
```

**How it works:**

1. Reads source markdown files from repository
2. **Rewrites relative links** to match Docusaurus structure
3. Generates Docusaurus frontmatter (title, description, slug, tags, keywords)
4. Escapes problematic MDX characters (e.g., `<`, `>` in prose)
5. Adds sync banner comment (`<!-- Auto-synced from ... -->`)
6. Writes to website `docs/` directory

**Link Rewriting:**

The script automatically rewrites relative links from repository structure to website structure:

| Repository Link | Website Link | Example |
|-----------------|--------------|---------|
| `./README.md` | `/docs` | Docs overview |
| `../README.md` | `/` | Repository root → homepage |
| `../../docs/heliosapi.md` | `/docs/api/overview` | API documentation |
| `../../docs/styleguide.md` | `/docs/contributing/styleguide` | Style guide |
| `./styleguide.md` | `/docs/contributing/styleguide` | Within docs/ |
| `./simple_cube_rendering/README.md` | `/docs/examples/simple-cube` | Example tutorial |

This ensures all internal links work correctly in the Docusaurus environment without manual editing.

**Frontmatter Example:**

```markdown
---
title: Simple Cube Rendering
description: "Tutorial: Rendering a 3D cube with helios - shaders, materials, meshes, and render loop."
slug: /examples/simple-cube
sidebar_label: Simple Cube
tags: [examples, rendering, tutorial]
keywords: [helios, 3D rendering, OpenGL, cube, tutorial]
---

<!-- Auto-synced from repository by scripts/sync-changelog.mjs. Do not edit this file directly. -->

# Simple Cube Rendering Tutorial
...
```

**MDX Escaping:**

The script automatically escapes characters that conflict with MDX/JSX:
- `<=` → `&lt;=`
- `>=` → `&gt;=`
- Isolated `<` and `>` surrounded by spaces

Code blocks are preserved without escaping.

**YAML Escaping:**

Frontmatter values containing special characters (`:`, `"`, etc.) are automatically quoted:
```yaml
description: "How to maintain the helios CHANGELOG: categories, release workflow"
# Colon in value requires quotes
```

## Adding New Synced Documents

To add a new document to sync:

1. Open `scripts/sync-changelog.mjs`
2. Add a new entry to the `syncMappings` array:

```javascript
{
  src: path.join(repoRoot, 'path/to/source.md'),
  dest: path.join(websiteRoot, 'docs', 'destination.md'),
  meta: {
    title: 'Document Title',
    description: 'Brief description for SEO',
    slug: '/destination',
    sidebar_label: 'Sidebar Label',
    tags: ['tag1', 'tag2'],
    keywords: ['keyword1', 'keyword2']
  }
}
```

3. Update `sidebars.ts` if needed
4. Run `node scripts/sync-changelog.mjs` to test
5. Commit both the script and resulting synced files

## CI/CD Integration

The sync script is automatically run during:
- **Local builds:** `npm run build` (via `package.json` build script)
- **GitHub Actions:** Website deployment workflow (`.github/workflows/deploy-docs.yml`)

## Troubleshooting

### Sync script fails with "Module not found"

Ensure you're running from the `website/` directory:
```bash
cd website
node scripts/sync-changelog.mjs
```

### Frontmatter parsing error

Check for unescaped special characters in metadata values. The script should auto-escape, but if issues persist:
- Manually quote the value in `meta` object
- Check for stray `---` in source markdown

### Links broken after sync

If Docusaurus shows warnings about unresolved links:

1. **Check if link is in the rewrite map:** Open `sync-changelog.mjs` and find the `rewriteLinks()` function
2. **Add missing mapping:**
   ```javascript
   const linkMap = {
     './your-file.md': '/docs/destination',
     // ... existing mappings
   };
   ```
3. **Run sync again:** `node scripts/sync-changelog.mjs`
4. **Verify in synced file:** Check that the link was rewritten correctly

**Common patterns:**
- `./file.md` → `/docs/section/file`
- `../file.md` → `/docs/file`
- `../../README.md` → `/` (homepage)

**External links** (starting with `http://` or `https://`) are not modified.

### MDX compilation errors

If MDX complains about `<` or `>`:
- Check if the character is in a code block (should be preserved)
- Verify the escaping logic in `escapeMDXCharacters()`
- Manually escape in source if needed: `&lt;`, `&gt;`

## Maintenance

When updating the script:
1. Test locally before committing
2. Verify all synced docs build successfully (`npm run build`)
3. Check that links and formatting are preserved
4. Update this README if behavior changes

---

For questions, see [Website Documentation](../README.md) or [Contributing Guide](../../docs/CONTRIBUTING.md).

