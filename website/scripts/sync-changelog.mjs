#!/usr/bin/env node
import { promises as fs } from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

/**
 * Syncs markdown files from repository root/docs into website build sources.
 * Ensures documentation stays in sync without duplication.
 */

const SYNC_BANNER = '<!-- Auto-synced from repository by scripts/sync-changelog.mjs. Do not edit this file directly. -->';

/**
 * Build frontmatter for a markdown file from its metadata.
 * Frontmatter is delimited by --- and contains YAML key-value pairs.
 */
function buildFrontmatter(meta) {
  const {
    title,
    description,
    slug,
    tags = [],
    keywords = [],
    sidebar_label,
    sidebar_position,
  } = meta;

  // Helper to escape YAML values (quote if contains special chars)
  const escapeYAML = (value) => {
    // Quote if contains: colon, quotes, brackets, or special YAML chars
    if (/[:"'\[\]{}#&*!|>@`]/.test(value)) {
      return `"${value.replace(/"/g, '\\"')}"`;
    }
    return value;
  };

  const lines = ['---'];
  lines.push(`title: ${escapeYAML(title)}`);
  if (description) lines.push(`description: ${escapeYAML(description)}`);
  if (slug) lines.push(`slug: ${slug}`);
  if (sidebar_label) lines.push(`sidebar_label: ${escapeYAML(sidebar_label)}`);
  if (sidebar_position !== undefined) lines.push(`sidebar_position: ${sidebar_position}`);
  if (tags.length) lines.push(`tags: [${tags.join(', ')}]`);
  if (keywords.length) lines.push(`keywords: [${keywords.join(', ')}]`);
  lines.push('---');
  // Join lines and ensure exactly two newlines after frontmatter block
  return lines.join('\n') + '\n\n';
}

function ensureFrontmatter(content, meta) {
  if (content.trimStart().startsWith('---')) {
    return { frontmatter: '', body: content }; // Quell-Dokument hat eigenes Frontmatter (selten)
  }
  const fm = buildFrontmatter(meta);
  return { frontmatter: fm, body: content.replace(/^[\n\r]+/, '') };
}

/**
 * Rewrite relative links to work in Docusaurus structure.
 * Maps repository paths to website paths.
 */
function rewriteLinks(content, sourceFile) {
  // Link mapping: repository path → website path
  const linkMap = {
    // Docs
    './README.md': '/docs',
    '../README.md': '/',
    '../../README.md': '/',
    '../docs/README.md': '/docs',
    '../../docs/README.md': '/docs',
    '../docs/api/': '/docs/api',
    '../../docs/api/': '/docs/api',
    '../docs/heliosapi.md': '/docs/api/overview',
    '../../docs/heliosapi.md': '/docs/api/overview',
    '../docs/styleguide.md': '/docs/contributing/styleguide',
    '../../docs/styleguide.md': '/docs/contributing/styleguide',
    './styleguide.md': '/docs/contributing/styleguide',
    './doxygen-style.md': '/docs/contributing/doxygen-style',

    // Examples
    '../simple_cube_rendering/README.md': '/docs/examples/simple-cube',
    './simple_cube_rendering/README.md': '/docs/examples/simple-cube',
    '../game_controller_input/README.md': '/docs/examples/gamepad-input',
    './game_controller_input/README.md': '/docs/examples/gamepad-input',
    '../examples/README.md': '/docs/examples',
    './examples/README.md': '/docs/examples',
    '../README.md': '/',
  };

  let result = content;

  // Replace markdown links: [text](url)
  for (const [oldPath, newPath] of Object.entries(linkMap)) {
    const regex = new RegExp(`\\]\\(${oldPath.replace(/\./g, '\\.').replace(/\//g, '\\/')}\\)`, 'g');
    result = result.replace(regex, `](${newPath})`);
  }

  return result;
}

function escapeMDXCharacters(content) {
  let result = '';
  let inCodeBlock = false;
  const lines = content.split('\n');
  for (const rawLine of lines) {
    let line = rawLine;
    if (line.trim().startsWith('```')) {
      inCodeBlock = !inCodeBlock;
      result += line + '\n';
      continue;
    }
    if (inCodeBlock) {
      result += line + '\n';
      continue;
    }
    // Escape only problematic standalone < or > in prose (not inside markdown links which have [text](url))
    line = line.replace(/ <= /g, ' &lt;= ');
    line = line.replace(/ >= /g, ' &gt;= ');
    // Replace stray < and > surrounded by spaces
    line = line.replace(/ (<) /g, ' &lt; ');
    line = line.replace(/ (>) /g, ' &gt; ');
    result += line + '\n';
  }
  return result.trimEnd();
}

async function copyMarkdown(src, dest, repoRoot, meta) {
  let raw = await fs.readFile(src, 'utf8');
  const { frontmatter, body } = ensureFrontmatter(raw, meta);
  const rewritten = rewriteLinks(body, src);
  const escaped = escapeMDXCharacters(rewritten);
  const full = frontmatter + SYNC_BANNER + '\n' + escaped.trimEnd() + '\n';
  await fs.mkdir(path.dirname(dest), { recursive: true });
  await fs.writeFile(dest, full, 'utf8');
  console.log(`[sync-docs] ✓ ${path.relative(repoRoot, src)} → ${path.relative(repoRoot, dest)}`);
}

async function main() {
  const __filename = fileURLToPath(import.meta.url);
  const __dirname = path.dirname(__filename);
  const repoRoot = path.resolve(__dirname, '..', '..');
  const websiteRoot = path.resolve(__dirname, '..');

  // Metadata mapping for synced docs
  const syncMappings = [
    {
      src: path.join(repoRoot, 'CHANGELOG.md'),
      dest: path.join(websiteRoot, 'docs', 'changelog.md'),
      meta: {
        title: 'Changelog',
        description: 'Chronological list of notable changes to helios; manually curated release notes.',
        slug: '/changelog',
        tags: ['changelog', 'release-notes'],
        keywords: ['helios', 'changelog', 'releases', 'version history'],
        sidebar_label: 'Changelog'
      }
    },
    {
      src: path.join(repoRoot, 'docs', 'styleguide.md'),
      dest: path.join(websiteRoot, 'docs', 'contributing', 'styleguide.md'),
      meta: {
        title: 'Code Style Guide',
        description: 'Coding style, modules, naming, formatting and logging conventions for helios.',
        slug: '/contributing/styleguide',
        tags: ['style', 'coding'],
        keywords: ['helios', 'cpp', 'styleguide', 'formatting', 'modules'],
        sidebar_label: 'Code Style'
      }
    },
    {
      src: path.join(repoRoot, 'docs', 'doxygen-style.md'),
      dest: path.join(websiteRoot, 'docs', 'contributing', 'doxygen-style.md'),
      meta: {
        title: 'Doxygen Style',
        description: 'Rules and examples for documenting public APIs using Doxygen in helios.',
        slug: '/contributing/doxygen-style',
        tags: ['docs', 'doxygen'],
        keywords: ['helios', 'doxygen', 'documentation style'],
        sidebar_label: 'Doxygen Style'
      }
    },
    {
      src: path.join(repoRoot, 'docs', 'CONTRIBUTING.md'),
      dest: path.join(websiteRoot, 'docs', 'contributing', 'guide.md'),
      meta: {
        title: 'Contributing Guide',
        description: 'Complete guide for contributing to helios: setup, commit conventions, pull requests, testing, and documentation.',
        slug: '/contributing/guide',
        tags: ['contributing', 'getting-started'],
        keywords: ['helios', 'contributing', 'pull requests', 'conventional commits', 'testing'],
        sidebar_label: 'Contributing Guide'
      }
    },
    {
      src: path.join(repoRoot, 'docs', 'CHANGELOG_GUIDE.md'),
      dest: path.join(websiteRoot, 'docs', 'contributing', 'changelog-guide.md'),
      meta: {
        title: 'Changelog Guide',
        description: 'How to maintain the helios CHANGELOG: categories, release workflow, migration notes.',
        slug: '/contributing/changelog-guide',
        tags: ['changelog', 'process'],
        keywords: ['helios', 'changelog maintenance', 'release process'],
        sidebar_label: 'Changelog Guide'
      }
    },
    {
      src: path.join(repoRoot, 'docs', 'testing.md'),
      dest: path.join(websiteRoot, 'docs', 'testing.md'),
      meta: {
        title: 'Testing',
        description: 'Running tests in helios: CTest usage, test patterns, debugging failures.',
        slug: '/testing',
        tags: ['testing', 'quality'],
        keywords: ['helios', 'testing', 'ctest', 'unit tests'],
        sidebar_label: 'Testing',
        sidebar_position: 3
      }
    },
    {
      src: path.join(repoRoot, 'examples', 'README.md'),
      dest: path.join(websiteRoot, 'docs', 'examples', 'overview.md'),
      meta: {
        title: 'Examples Overview',
        description: 'Example applications demonstrating helios features: rendering, input, scene graph, and more.',
        slug: '/examples',
        tags: ['examples', 'tutorial'],
        keywords: ['helios', 'examples', 'tutorials', 'getting started'],
        sidebar_label: 'Overview'
      }
    },
    {
      src: path.join(repoRoot, 'examples', 'simple_cube_rendering', 'README.md'),
      dest: path.join(websiteRoot, 'docs', 'examples', 'simple-cube.md'),
      meta: {
        title: 'Simple Cube Rendering',
        description: 'Tutorial: Rendering a 3D cube with helios - shaders, materials, meshes, and render loop.',
        slug: '/examples/simple-cube',
        tags: ['examples', 'rendering', 'tutorial'],
        keywords: ['helios', '3D rendering', 'OpenGL', 'cube', 'tutorial'],
        sidebar_label: 'Simple Cube'
      }
    },
    {
      src: path.join(repoRoot, 'examples', 'game_controller_input', 'README.md'),
      dest: path.join(websiteRoot, 'docs', 'examples', 'gamepad-input.md'),
      meta: {
        title: 'Game Controller Input',
        description: 'Tutorial: Handling gamepad/controller input in helios - buttons, analog sticks, and triggers.',
        slug: '/examples/gamepad-input',
        tags: ['examples', 'input', 'tutorial'],
        keywords: ['helios', 'gamepad', 'controller', 'input', 'tutorial'],
        sidebar_label: 'Gamepad Input'
      }
    }
  ];

  console.log('[sync-docs] Synchronizing repository documentation...\n');
  for (const { src, dest, meta } of syncMappings) {
    try {
      await copyMarkdown(src, dest, repoRoot, meta);
    } catch (err) {
      console.error(`[sync-docs] ✗ Failed: ${path.relative(repoRoot, src)} → ${err.message}`);
      throw err;
    }
  }
  console.log('\n[sync-docs] All documentation synchronized successfully.');
}

main().catch(err => {
  console.error('\n[sync-docs] Fatal error:', err);
  process.exit(1);
});

